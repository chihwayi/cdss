package rules.hiv;

import java.time.LocalDate;
import java.time.Period;
import java.util.List;
import java.util.Map;
import java.util.HashMap;
import java.time.format.DateTimeFormatter;

// Helper methods
function int getYearsDifference(String dateStr) {
    DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd");
    LocalDate date = LocalDate.parse(dateStr, formatter);
    return Period.between(date, LocalDate.now()).getYears();
}

function int getMonthsDifference(String dateStr) {
    DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd");
    LocalDate date = LocalDate.parse(dateStr, formatter);
    return (int) Period.between(date, LocalDate.now()).toTotalMonths();
}


// Rule for Treatment Change Required
rule "Treatment Change Alert"
    when
        $patient: Map()
        $statuses: List() from $patient.get("statuses")
        $currentStatus: Map(
            $state: get("state") == "CHANGE"
        ) from $statuses.get(0)
    then
        Map<String, Object> alert = new HashMap<>();
        alert.put("type", "TREATMENT_CHANGE");
        alert.put("severity", "HIGH");
        alert.put("message", "Treatment change is required. Clinical review needed for new regimen assignment.");
        insert(alert);
end